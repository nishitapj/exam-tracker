<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§û Domain Expansion: V Sem</title>
    <style>
        /* --- CSS STYLES --- */
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9;
            --subtext: #94a3b8; --accent: #38bdf8;
            --success: #22c55e; --danger: #ef4444; --warning: #eab308;
            --border: #334155;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg); color: var(--text);
            margin: 0; padding: 20px; line-height: 1.6;
        }
        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 80px; }
        a { text-decoration: none; color: inherit; cursor: pointer; }
        
        /* Dashboard */
        .dashboard-header { text-align: center; margin-bottom: 30px; }
        .countdown-box { 
            background: linear-gradient(45deg, #ef4444, #b91c1c); 
            padding: 15px 25px; border-radius: 12px; display: inline-block;
            margin-top: 15px; font-weight: bold; font-size: 1.3rem;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        .section-title { 
            border-bottom: 2px solid var(--border); padding-bottom: 10px; 
            margin-top: 40px; color: var(--accent); font-size: 1.2rem; 
            text-transform: uppercase; letter-spacing: 1px;
        }
        
        /* Grid (De-Congested) */
        .subject-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; margin-top: 10px;
        }
        .subject-card {
            background: var(--card); padding: 25px; border-radius: 16px;
            border: 1px solid var(--border); display: flex; flex-direction: column;
            justify-content: space-between; transition: transform 0.2s; position: relative;
        }
        .subject-card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .subject-code { font-size: 1.8rem; font-weight: 800; display: block; margin-bottom: 5px; }
        .target-grade { background: rgba(34, 197, 94, 0.1); color: var(--success); padding: 4px 8px; border-radius: 4px; font-size: 0.9rem; font-weight: 600; display: inline-block; margin-bottom: 15px; }

        /* Progress & Badges */
        .mini-progress { height: 8px; background: #334155; margin-top: 20px; border-radius: 4px; overflow: hidden; }
        .mini-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.5s ease; }
        .countdown-badge { 
            display: block; text-align: center; font-weight: 800; 
            padding: 8px; border-radius: 8px; margin-top: 15px; font-size: 0.95rem;
        }
        .exam-meta { font-size: 0.9rem; color: #cbd5e1; margin-top: 5px; opacity: 0.9; }

        /* BATTERY & LP Button */
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .lp-btn {
            background: var(--warning); color: #000; font-weight: bold;
            padding: 5px 12px; border-radius: 6px; font-size: 0.9rem;
            border: 2px solid #ca8a04; transition: 0.2s;
        }
        .lp-btn:hover { background: #ca8a04; color: #fff; }

        .battery-container {
            width: 100px; height: 24px;
            border: 2px solid #cbd5e1; border-radius: 4px;
            padding: 2px; position: relative; display: flex; align-items: center;
        }
        .battery-container::after {
            content: ''; position: absolute; right: -6px; top: 6px;
            height: 10px; width: 4px; background: #cbd5e1; border-radius: 0 2px 2px 0;
        }
        .battery-fill {
            height: 100%; background: var(--success); width: 0%;
            border-radius: 2px; transition: width 0.3s ease;
        }
        .battery-text {
            position: absolute; width: 100%; text-align: center;
            font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.8); z-index: 10; font-size: 0.75rem;
        }

        /* Pages */
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .back-btn { background: #334155; padding: 8px 20px; border-radius: 20px; font-size: 0.95rem; font-weight: 600;}
        
        /* CHAPTER ITEMS */
        .unit-group { margin-bottom: 30px; }
        .unit-title { font-size: 0.9rem; color: var(--subtext); text-transform: uppercase; font-weight: bold; margin-bottom: 10px; letter-spacing: 0.5px; border-bottom: 1px solid #334155; padding-bottom: 5px; }
        
        .topic-item {
            background: var(--card); padding: 18px; border-radius: 10px;
            margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;
            border: 1px solid transparent; transition: 0.2s;
        }
        .topic-item:hover { border-color: var(--border); }
        
        .topic-content { display: flex; align-items: center; gap: 15px; flex-grow: 1; }
        .chapter-plus-btn {
            background: rgba(255,255,255,0.05); color: var(--accent);
            width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer; transition: 0.2s; margin-left: 10px;
        }
        .chapter-plus-btn:hover { background: var(--accent); color: #000; }

        .strikethrough { text-decoration: line-through; opacity: 0.5; }
        input[type="checkbox"] { width: 22px; height: 22px; accent-color: var(--success); cursor: pointer; }

        /* MODALS */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); margin: 10vh auto; padding: 30px; width: 90%; max-width: 600px; border-radius: 16px; border: 1px solid var(--accent); position: relative; max-height: 80vh; overflow-y: auto; }
        .close-modal { position: absolute; top: 15px; right: 25px; font-size: 2rem; cursor: pointer; color: var(--subtext); }
        
        .note-choice-btn { 
            display: block; width: 100%; padding: 15px; margin-bottom: 10px; 
            background: #334155; color: white; border: none; border-radius: 8px; 
            text-align: left; font-size: 1rem; cursor: pointer; 
        }
        .note-choice-btn:hover { background: var(--accent); color: #000; }
        
        textarea { width: 100%; height: 150px; background: #0f172a; color: #fff; border: 1px solid #334155; padding: 15px; border-radius: 8px; margin-bottom: 15px; resize: vertical; font-family: inherit; box-sizing: border-box;}
        .file-upload { display: block; margin-bottom: 15px; color: var(--subtext); font-size: 0.9rem; padding: 10px; border: 2px dashed #334155; border-radius: 8px; text-align: center; cursor: pointer; }
        .file-upload:hover { border-color: var(--accent); color: var(--accent); }
        
        .save-btn { width: 100%; background: var(--success); color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .save-btn:hover { filter: brightness(1.1); }

        /* LP IMAGE STYLES */
        #lp-image { width: 100%; border-radius: 8px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* Debug Status */
        #status-log { position: fixed; bottom: 10px; right: 10px; font-size: 0.7rem; opacity: 0.5; font-family: monospace; }
        
        /* Revision Button at Bottom */
        .revision-footer-btn {
            background: #1e293b; padding: 20px; border-radius: 12px; border-left: 5px solid #eab308;
            cursor: pointer; margin-top: 50px; display: flex; justify-content: space-between; align-items: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="status-log">Initializing...</div>

        <div id="choice-modal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <span class="close-modal" onclick="closeModal('choice-modal')">&times;</span>
                <h2 id="choice-title" style="margin-top:0; margin-bottom: 20px;">Manage Chapter</h2>
                <button class="note-choice-btn" onclick="openAddNote()">üìù Add Note / Attach File</button>
                <button class="note-choice-btn" onclick="openViewNotes()">üìÇ View Past Details</button>
            </div>
        </div>

        <div id="add-note-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal('add-note-modal')">&times;</span>
                <h2 style="margin-top:0">Add to Notebook</h2>
                <p id="add-note-subtitle" style="color:var(--subtext); font-size:0.9rem; margin-bottom:15px;"></p>
                <textarea id="note-text" placeholder="Write formulas, key points, or reminders..."></textarea>
                <label class="file-upload">
                    üìé Upload PDF, Doc, or Image
                    <input type="file" id="note-file" accept=".pdf,.doc,.docx,image/*" style="display:none" onchange="handleFileUpload()">
                </label>
                <div id="upload-preview" style="margin-bottom: 15px; color: var(--accent);"></div>
                <button onclick="saveNote()" class="save-btn" id="save-note-btn">Save Entry</button>
            </div>
        </div>

        <div id="view-note-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal('view-note-modal')">&times;</span>
                <h2 style="margin-top:0">Chapter History</h2>
                <div id="history-content"></div>
            </div>
        </div>

        <div id="lp-modal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <span class="close-modal" onclick="closeModal('lp-modal')">&times;</span>
                <h2 style="margin-top:0">Syllabus Copy (LP)</h2>
                <p style="color:var(--subtext); font-size:0.9rem;">Upload your syllabus image once, and it will stay here.</p>
                
                <label class="file-upload" style="width: fit-content; margin: 0 auto;">
                    üìé Upload New Syllabus Image
                    <input type="file" id="lp-upload-input" accept="image/*" style="display:none" onchange="uploadLP()">
                </label>

                <img id="lp-image" src="https://via.placeholder.com/800x600?text=No+Syllabus+Image+Uploaded" alt="Syllabus">
            </div>
        </div>

        <div id="dashboard-page" class="page active">
            <div class="dashboard-header">
                <h1>ü§û Domain Expansion: V Sem</h1>
                <div id="main-countdown" class="countdown-box">Calculating...</div>
            </div>

            <h3 class="section-title">‚ö° Today's Targets</h3>
            <div id="today-tasks">Loading...</div>

            <h3 class="section-title">üìö Subject Modules</h3>
            <div class="subject-grid" id="subject-grid"></div>

            <div onclick="showPage('revision-page')" class="revision-footer-btn">
                <div>
                    <strong style="font-size: 1.1rem;">‚ö° Last Minute Revision / Cheat Sheets</strong>
                    <div style="font-size: 0.9rem; color: #94a3b8;">Key formulas and diagrams for every subject</div>
                </div>
                <span style="font-size: 1.5rem;">&rarr;</span>
            </div>
        </div>

        <div id="subject-page" class="page">
            <div class="top-bar">
                <a onclick="goBack()" class="back-btn">‚Üê Back</a>
                <div class="header-actions">
                    <button class="lp-btn" onclick="openLP()">üìú LP Syllabus</button>
                    <div class="battery-container">
                        <div class="battery-fill" id="battery-fill"></div>
                        <div class="battery-text" id="battery-text">0%</div>
                    </div>
                </div>
            </div>
            <h2 id="sub-page-title" style="margin:0; font-size: 2rem;">Subject</h2>
            <p id="sub-page-meta" style="color:var(--accent); margin-bottom: 30px; margin-top: 5px; font-size: 1rem;"></p>
            <div id="topics-list"></div>
        </div>

        <div id="revision-page" class="page">
            <div class="top-bar">
                <a onclick="goBack()" class="back-btn">‚Üê Back</a>
                <h2 style="margin:0; color:var(--warning)">‚ö° Cheat Sheets</h2>
            </div>
            <div id="revision-list"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCYyXAEMh2dTI_JvNzxqlLUMVBbWnIO7ho",
            authDomain: "exam-tracker-23c1c.firebaseapp.com",
            projectId: "exam-tracker-23c1c",
            storageBucket: "exam-tracker-23c1c.firebasestorage.app",
            messagingSenderId: "285050323574",
            appId: "1:285050323574:web:76ede5dd9e824f30a0d557",
            measurementId: "G-NGL34V940J"
        };

        // --- DATA (Verified with your images) ---
        // UPDATED: Replaced all "Read Summaries" with actual Unit 1/Intro chapters
        const fullSyllabus = {
            "ML": {
                title: "Machine Learning", target: "58/60 (S Grade)", 
                examDate: "2026-01-28", examTime: "9:30 AM - 11:30 AM",
                topics: [
                    // Jan 21 (Today)
                    { id: "ml_ch4", unit: "Unit 2 (Jan 21)", title: "Chapter 4: Neural Networks", date: "2026-01-21" },
                    { id: "ml_ch5", unit: "Unit 2 (Jan 21)", title: "Chapter 5: Deep Neural Networks", date: "2026-01-21" },
                    // Jan 26
                    { id: "ml_ch1", unit: "Unit 1 (Jan 26)", title: "Chapter 1: Intro & Regression", date: "2026-01-26" },
                    { id: "ml_ch2", unit: "Unit 1 (Jan 26)", title: "Chapter 2: Classification", date: "2026-01-26" },
                    { id: "ml_ch6", unit: "Unit 2 (Jan 26)", title: "Chapter 6: Seq2Seq Models", date: "2026-01-26" },
                    // Jan 27
                    { id: "ml_ch3", unit: "Unit 1 (Jan 27)", title: "Chapter 3: Ensemble Learning", date: "2026-01-27" },
                    { id: "ml_rev", unit: "Revision (Jan 27)", title: "Revision and Solve Previous Year Papers", date: "2026-01-27" }
                ],
                revision: ["Derivation: Backpropagation", "Formula: MSE & Gradient Descent", "Diagram: AlexNet Layers", "Concept: Ridge vs Lasso"]
            },
            "SE": {
                title: "Software Engineering", target: "91/100 (A Grade)", 
                examDate: "2026-01-30", examTime: "9:30 AM - 12:30 PM",
                topics: [
                    { id: "se_ch1", unit: "Unit 1 (Jan 22)", title: "Ch 1: SE Process & Req Eng", date: "2026-01-22" },
                    { id: "se_ch6", unit: "Unit 3 (Jan 22)", title: "Ch 6: Intro to DevOps", date: "2026-01-22" },
                    { id: "se_ch2", unit: "Unit 1 (Jan 28)", title: "Ch 2: Agile Frameworks (Scrum/XP)", date: "2026-01-28" },
                    { id: "se_ch3", unit: "Unit 1 (Jan 28)", title: "Ch 3: Agile Planning & Estimation", date: "2026-01-28" },
                    { id: "se_ch4", unit: "Unit 2 (Jan 28)", title: "Ch 4: System Modeling & Design", date: "2026-01-28" },
                    { id: "se_ch5", unit: "Unit 2 (Jan 29)", title: "Ch 5: Testing (TDD/Agile)", date: "2026-01-29" },
                    { id: "se_rev", unit: "Revision (Jan 29)", title: "Revision and Solve Previous Year Papers", date: "2026-01-29" }
                ],
                revision: ["Diagram: Jenkins Master-Slave", "List: 4 Agile Values", "Concept: INVEST Model"]
            },
            "CN": {
                title: "Computer Networks 2", target: "91/100 (A Grade)", 
                examDate: "2026-02-02", examTime: "9:30 AM - 12:30 PM",
                topics: [
                    { id: "cn_ch6", unit: "Unit 3 (Jan 23)", title: "Ch 6: Multimedia Networking", date: "2026-01-23" },
                    { id: "cn_ch2", unit: "Unit 1 (Jan 23)", title: "Ch 2: Queuing Theory", date: "2026-01-23" },
                    { id: "cn_ch1", unit: "Unit 1 (Jan 31)", title: "Ch 1: Routing Algos (RIP/OSPF/BGP)", date: "2026-01-31" },
                    { id: "cn_ch3", unit: "Unit 2 (Jan 31)", title: "Ch 3: Data Link Layer (CRC)", date: "2026-01-31" },
                    { id: "cn_ch4", unit: "Unit 2 (Feb 01)", title: "Ch 4: Switched LANs", date: "2026-02-01" },
                    { id: "cn_rev", unit: "Revision (Feb 01)", title: "Revision and Solve Previous Year Papers", date: "2026-02-01" }
                ],
                revision: ["Formula: Little's Law", "Math: CRC Division", "Diagram: OSPF Header"]
            },
            "CC": {
                title: "Cloud Computing", target: "59/60 (A Grade)", 
                examDate: "2026-02-05", examTime: "9:30 AM - 11:30 AM",
                topics: [
                    { id: "cc_ch1", unit: "Unit 1 (Jan 24)", title: "Ch 1: Intro to Cloud & DCs", date: "2026-01-24" },
                    { id: "cc_ch2", unit: "Unit 1 (Jan 24)", title: "Ch 2: Virtualization", date: "2026-01-24" },
                    { id: "cc_ch3", unit: "Unit 1 (Feb 03)", title: "Ch 3: Automation (K8s)", date: "2026-02-03" },
                    { id: "cc_ch4", unit: "Unit 2 (Feb 03)", title: "Ch 4: Microservices", date: "2026-02-03" },
                    { id: "cc_ch5", unit: "Unit 2 (Feb 03)", title: "Ch 5: Serverless", date: "2026-02-03" },
                    { id: "cc_ch6", unit: "Unit 2 (Feb 04)", title: "Ch 6: DevOps for Cloud", date: "2026-02-04" },
                    { id: "cc_rev", unit: "Revision (Feb 04)", title: "Revision and Solve Previous Year Papers", date: "2026-02-04" }
                ],
                revision: ["Diagram: K8s Cluster", "Code: Dockerfile", "Diagram: Leaf-Spine"]
            },
            "CV": {
                title: "Computer Vision", target: "96/100 (S Grade)", 
                examDate: "2026-02-06", examTime: "9:30 AM - 12:30 PM",
                topics: [
                    { id: "cv_ch1", unit: "Unit 1 (Jan 25)", title: "Ch 1: Intro & Image Rep", date: "2026-01-25" },
                    { id: "cv_ch2", unit: "Unit 1 (Jan 25)", title: "Ch 2: Features (Edge/SIFT)", date: "2026-01-25" },
                    { id: "cv_ch3", unit: "Unit 2 (Jan 25)", title: "Ch 3: Segmentation", date: "2026-01-25" },
                    { id: "cv_ch5", unit: "Unit 3 (Jan 25)", title: "Ch 5: Advanced Techniques", date: "2026-01-25" },
                    { id: "cv_ch4", unit: "Unit 2 (Feb 05)", title: "Ch 4: Motion (Optical Flow)", date: "2026-02-05" },
                    { id: "cv_rev", unit: "Revision (Feb 05)", title: "Revision and Solve Previous Year Papers", date: "2026-02-05" }
                ],
                revision: ["Equation: 2D Gaussian", "Steps: Canny Edge", "Equation: Optical Flow"]
            }
        };

        // --- APP STATE ---
        let db = null;
        let progressMap = {};
        let activeChapterId = null; 
        const USER_ID = "my_exam_tracker";

        function log(msg) { console.log(msg); document.getElementById('status-log').innerText = msg; }

        async function initApp() {
            log("Connecting...");
            const timeout = setTimeout(() => { log("Offline Mode active."); renderAll(); }, 3000);

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                const docRef = doc(db, "trackers", USER_ID);
                const snap = await getDoc(docRef);

                clearTimeout(timeout);

                if (snap.exists()) {
                    progressMap = snap.data();
                    log("Synced.");
                } else {
                    log("Creating DB...");
                    let schema = {};
                    Object.values(fullSyllabus).forEach(sub => sub.topics.forEach(t => schema[t.id] = false));
                    await setDoc(docRef, schema);
                    progressMap = schema;
                }
            } catch (e) {
                console.error(e);
                log("DB Error. Offline.");
            }
            // Load saved LP image from local storage if exists
            const currentSub = localStorage.getItem('last_viewed_subject');
            if(currentSub) {
                const savedLP = localStorage.getItem(`lp_image_${currentSub}`);
                if(savedLP && document.getElementById('lp-image')) {
                   document.getElementById('lp-image').src = savedLP;
                }
            }
            renderAll();
        }

        function renderAll() { renderDashboard(); renderRevision(); }

        function renderDashboard() {
            const todayStr = new Date().toISOString().split('T')[0];
            const grid = document.getElementById('subject-grid');
            const todayBox = document.getElementById('today-tasks');
            grid.innerHTML = "";
            todayBox.innerHTML = "";

            let nearestObj = { name: "", days: 999, title: "" };
            let hasTasks = false;

            for (const [key, data] of Object.entries(fullSyllabus)) {
                const examDate = new Date(data.examDate);
                const diff = Math.ceil((examDate - new Date()) / (1000 * 60 * 60 * 24));
                
                const total = data.topics.length;
                const done = data.topics.filter(t => progressMap[t.id] === true).length;
                const percent = total ? Math.round((done/total)*100) : 0;

                if (diff >= 0 && diff < nearestObj.days) nearestObj = { name: key, days: diff, title: data.title };

                let badgeColor = "#334155";
                let badgeText = `${diff} Days Left`;
                if(diff === 0) { badgeColor = "#ef4444"; badgeText = "TODAY!"; }
                else if(diff === 1) { badgeColor = "#eab308"; badgeText = "TOMORROW!"; }

                const card = document.createElement('div');
                card.className = "subject-card";
                card.onclick = () => openSubject(key);
                
                card.innerHTML = `
                    <div>
                        <span class="subject-code">${key}</span>
                        <div class="target-grade">Target: ${data.target}</div>
                        <div class="exam-meta">üìÖ ${data.examDate}<br>‚è∞ ${data.examTime}</div>
                    </div>
                    <div>
                        <div class="countdown-badge" style="background:${badgeColor}">${badgeText}</div>
                        <div class="mini-progress"><div class="mini-fill" style="width:${percent}%"></div></div>
                    </div>
                `;
                grid.appendChild(card);

                // Today's Tasks
                data.topics.forEach(t => {
                    if (t.date === todayStr && progressMap[t.id] !== true) {
                        hasTasks = true;
                        todayBox.innerHTML += `
                            <div class="topic-item" style="border-left:4px solid var(--accent)">
                                <div><strong>[${key}]</strong> ${t.title}<br><small>${t.unit}</small></div>
                                <a onclick="openSubject('${key}')" style="color:var(--accent)">GO &rarr;</a>
                            </div>`;
                    }
                });
            }

            if(!hasTasks) todayBox.innerHTML = `<div class="topic-item" style="border-left:4px solid var(--success)">üéâ All Caught Up!</div>`;
            
            const countEl = document.getElementById('main-countdown');
            if(nearestObj.days === 0) {
                countEl.innerHTML = `üö® EXAM DAY: ${nearestObj.title} üö®`;
                countEl.style.background = "#ef4444";
            } else {
                countEl.innerHTML = `üî• Next: ${nearestObj.name} in ${nearestObj.days} Days`;
            }
        }

        // --- CHAPTER NOTES LOGIC ---
        window.openChapterOptions = (chapterId, title) => {
            activeChapterId = chapterId;
            document.getElementById('choice-title').innerText = title;
            document.getElementById('choice-modal').style.display = 'block';
        };

        window.openAddNote = () => {
            closeModal('choice-modal');
            document.getElementById('add-note-subtitle').innerText = `Adding entry for: ${activeChapterId}`;
            document.getElementById('note-text').value = "";
            document.getElementById('note-file').value = "";
            document.getElementById('upload-preview').innerText = "";
            document.getElementById('add-note-modal').style.display = 'block';
        };

        window.openViewNotes = async () => {
            closeModal('choice-modal');
            const container = document.getElementById('history-content');
            container.innerHTML = "Loading...";
            document.getElementById('view-note-modal').style.display = 'block';

            const docRef = doc(db, "trackers", USER_ID);
            const snap = await getDoc(docRef);
            const data = snap.data();
            const notes = data[`notes_${activeChapterId}`] || [];

            container.innerHTML = "";
            if(notes.length === 0) {
                container.innerHTML = "<p style='color:var(--subtext)'>No notes found for this chapter.</p>";
                return;
            }

            notes.reverse().forEach(n => {
                let attachmentHtml = "";
                if(n.fileType && n.fileData) {
                    if(n.fileType.startsWith('image/')) {
                        attachmentHtml = `<img src="${n.fileData}" style="max-width:100%; border-radius:8px; margin-top:10px;">`;
                    } else {
                        attachmentHtml = `<div style="margin-top:10px; padding:10px; background:#0f172a; border-radius:6px;">üìÑ Attached File</div>`;
                    }
                }
                container.innerHTML += `
                    <div style="background:#2d3748; padding:15px; border-radius:8px; margin-bottom:15px;">
                        <div style="font-size:0.8rem; color:var(--accent); margin-bottom:5px;">${new Date(n.timestamp).toLocaleString()}</div>
                        <div style="white-space: pre-wrap;">${n.text}</div>
                        ${attachmentHtml}
                    </div>
                `;
            });
        };

        window.handleFileUpload = () => {
            const file = document.getElementById('note-file').files[0];
            if(file) document.getElementById('upload-preview').innerText = `Selected: ${file.name}`;
        };

        window.saveNote = async () => {
            const btn = document.getElementById('save-note-btn');
            btn.innerText = "Saving...";
            
            const text = document.getElementById('note-text').value;
            const file = document.getElementById('note-file').files[0];
            let fileData = null;
            let fileType = null;

            if (file) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                await new Promise(r => reader.onload = r);
                fileData = reader.result;
                fileType = file.type;
            }

            const noteEntry = {
                text: text,
                fileData: fileData,
                fileType: fileType,
                timestamp: Date.now()
            };

            if(db) {
                try {
                    await updateDoc(doc(db, "trackers", USER_ID), { 
                        [`notes_${activeChapterId}`]: arrayUnion(noteEntry)
                    });
                    btn.innerText = "Saved!";
                    setTimeout(() => { closeModal('add-note-modal'); btn.innerText="Save Entry"; }, 1000);
                } catch(e) { console.error(e); btn.innerText = "Error!"; }
            }
        };

        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        // --- LP SYLLABUS LOGIC ---
        window.openLP = () => {
            // Load correct image for subject
            const sub = localStorage.getItem('last_viewed_subject');
            const savedImg = localStorage.getItem(`lp_image_${sub}`);
            document.getElementById('lp-image').src = savedImg || "https://via.placeholder.com/800x600?text=Upload+Your+Syllabus+Pic";
            document.getElementById('lp-modal').style.display = 'block';
        };

        window.uploadLP = () => {
            const file = document.getElementById('lp-upload-input').files[0];
            const img = document.getElementById('lp-image');
            const sub = localStorage.getItem('last_viewed_subject');
            
            if (file && sub) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    img.src = reader.result;
                    localStorage.setItem(`lp_image_${sub}`, reader.result);
                };
                reader.readAsDataURL(file);
            }
        };

        // --- NAVIGATION ---
        function renderRevision() {
            const list = document.getElementById('revision-list');
            list.innerHTML = "";
            for (const [key, data] of Object.entries(fullSyllabus)) {
                let html = `<div class="rev-card">
                    <div class="rev-header" onclick="this.nextElementSibling.classList.toggle('open')">
                        ${key} Cheat Sheet <span>‚ñº</span>
                    </div>
                    <div class="rev-content">`;
                data.revision.forEach(r => html += `<div class="rev-item">‚Ä¢ ${r}</div>`);
                html += `</div></div>`;
                list.innerHTML += html;
            }
        }

        window.showPage = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0, 0); // AUTO-SCROLL FIX
        };

        window.goBack = () => { renderDashboard(); showPage('dashboard-page'); };

        window.openSubject = (key) => {
            localStorage.setItem('last_viewed_subject', key); // Track for LP upload
            const data = fullSyllabus[key];
            document.getElementById('sub-page-title').innerText = data.title;
            document.getElementById('sub-page-meta').innerText = `Target: ${data.target}`;
            const list = document.getElementById('topics-list');
            list.innerHTML = "";
            
            // Battery
            const total = data.topics.length;
            const done = data.topics.filter(t => progressMap[t.id] === true).length;
            const batPercent = total ? Math.round((done/total)*100) : 0;
            const fill = document.getElementById("battery-fill");
            const txt = document.getElementById("battery-text");
            fill.style.width = `${batPercent}%`;
            txt.innerText = `${batPercent}%`;
            if(batPercent < 30) fill.style.background = "#ef4444"; 
            else if(batPercent < 70) fill.style.background = "#eab308"; 
            else fill.style.background = "#22c55e"; 

            // Group by Unit
            const grouped = {};
            data.topics.forEach(t => {
                if(!grouped[t.unit]) grouped[t.unit] = [];
                grouped[t.unit].push(t);
            });

            for(const [unit, topics] of Object.entries(grouped)) {
                let html = `<div class="unit-group"><div class="unit-title">${unit}</div>`;
                topics.forEach(t => {
                    const isDone = progressMap[t.id] === true;
                    html += `
                        <div class="topic-item">
                            <div class="topic-content">
                                <input type="checkbox" onchange="toggleTopic('${t.id}', this.checked)" ${isDone ? 'checked' : ''}>
                                <span class="${isDone ? 'strikethrough' : ''}">${t.title}</span>
                            </div>
                            <div class="chapter-plus-btn" onclick="openChapterOptions('${t.id}', '${t.title}')">+</div>
                        </div>`;
                });
                html += `</div>`;
                list.innerHTML += html;
            }
            showPage('subject-page');
        };

        window.toggleTopic = async (id, checked) => {
            progressMap[id] = checked;
            const checkbox = document.querySelector(`input[onchange*="'${id}'"]`);
            if(checkbox) {
                const text = checkbox.nextElementSibling;
                if(checked) text.classList.add('strikethrough'); else text.classList.remove('strikethrough');
            }
            
            const currentSub = Object.keys(fullSyllabus).find(k => fullSyllabus[k].topics.some(t => t.id === id));
            if(currentSub) {
                const data = fullSyllabus[currentSub];
                const total = data.topics.length;
                const done = data.topics.filter(t => progressMap[t.id] === true).length;
                const batPercent = total ? Math.round((done/total)*100) : 0;
                document.getElementById("battery-fill").style.width = `${batPercent}%`;
                document.getElementById("battery-text").innerText = `${batPercent}%`;
            }

            if(db) {
                try {
                    await updateDoc(doc(db, "trackers", USER_ID), { [id]: checked });
                } catch(e) { console.error("Save failed", e); }
            }
        };

        initApp();
    </script>
</body>

</html>

